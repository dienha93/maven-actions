name: Release Action

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" ]]; then
          VERSION="${{ github.ref_name }}"
          IS_PRERELEASE="false"
        else
          VERSION="${{ github.event.inputs.version }}"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
        fi
        
        # Validate version format (v1.2.3 or v1.2.3-beta.1)
        if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
          echo "‚ùå Invalid version format: $VERSION"
          echo "Expected format: v1.2.3 or v1.2.3-beta.1"
          exit 1
        fi
        
        # Check if version already exists
        if git tag -l | grep -q "^$VERSION$"; then
          echo "‚ùå Version $VERSION already exists"
          exit 1
        fi
        
        echo "‚úÖ Version validation passed: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: validate-version
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint
    
    - name: Run unit tests
      run: npm test -- --coverage --coverageReporters=text-lcov
    
    - name: Build action
      run: npm run build
    
    - name: Package action
      run: npm run package
    
    - name: Verify dist directory
      run: |
        if [[ ! -f "dist/index.js" ]]; then
          echo "‚ùå dist/index.js not found after build"
          exit 1
        fi
        
        if [[ ! -f "dist/licenses.txt" ]]; then
          echo "‚ùå dist/licenses.txt not found after build"
          exit 1
        fi
        
        echo "‚úÖ Build artifacts verified"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: action-dist
        path: |
          dist/
          action.yml
          README.md
          LICENSE
        retention-days: 30

  integration-test:
    name: Integration Test
    runs-on: ${{ matrix.os }}
    needs: [validate-version, build-and-test]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java-version: ['11', '17', '21']
        maven-version: ['3.8.8', '3.9.5']
        exclude:
          # Reduce matrix size for faster testing
          - os: windows-latest
            java-version: '11'
          - os: macos-latest
            java-version: '11'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: action-dist
        path: .
    
    - name: Create test Maven project
      shell: bash
      run: |
        mkdir test-project
        cd test-project
        cat > pom.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <project xmlns="http://maven.apache.org/POM/4.0.0"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.example</groupId>
            <artifactId>test-project</artifactId>
            <version>1.0.0</version>
            <packaging>jar</packaging>
            
            <properties>
                <maven.compiler.source>${{ matrix.java-version }}</maven.compiler.source>
                <maven.compiler.target>${{ matrix.java-version }}</maven.compiler.target>
                <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
            </properties>
            
            <dependencies>
                <dependency>
                    <groupId>org.junit.jupiter</groupId>
                    <artifactId>junit-jupiter</artifactId>
                    <version>5.10.1</version>
                    <scope>test</scope>
                </dependency>
            </dependencies>
            
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-surefire-plugin</artifactId>
                        <version>3.2.2</version>
                    </plugin>
                </plugins>
            </build>
        </project>
        EOF
        
        mkdir -p src/main/java/com/example
        cat > src/main/java/com/example/App.java << 'EOF'
        package com.example;
        
        public class App {
            public static void main(String[] args) {
                System.out.println("Hello World from Java ${{ matrix.java-version }}!");
            }
            
            public String getMessage() {
                return "Hello World from Java ${{ matrix.java-version }}!";
            }
        }
        EOF
        
        mkdir -p src/test/java/com/example
        cat > src/test/java/com/example/AppTest.java << 'EOF'
        package com.example;
        
        import org.junit.jupiter.api.Test;
        import static org.junit.jupiter.api.Assertions.*;
        
        public class AppTest {
            @Test
            public void testGetMessage() {
                App app = new App();
                assertEquals("Hello World from Java ${{ matrix.java-version }}!", app.getMessage());
            }
        }
        EOF
    
    - name: Test Action - Validate
      uses: ./
      with:
        operation: 'validate'
        working-directory: 'test-project'
        java-version: ${{ matrix.java-version }}
        maven-version: ${{ matrix.maven-version }}
    
    - name: Test Action - Compile
      uses: ./
      with:
        operation: 'compile'
        working-directory: 'test-project'
        java-version: ${{ matrix.java-version }}
        maven-version: ${{ matrix.maven-version }}
        cache-enabled: true
    
    - name: Test Action - Test
      uses: ./
      with:
        operation: 'test'
        working-directory: 'test-project'
        java-version: ${{ matrix.java-version }}
        maven-version: ${{ matrix.maven-version }}
    
    - name: Test Action - Package
      uses: ./
      with:
        operation: 'package'
        working-directory: 'test-project'
        java-version: ${{ matrix.java-version }}
        maven-version: ${{ matrix.maven-version }}
        maven-args: '-DskipTests=false'
    
    - name: Test Action - Custom Environment Variables
      uses: ./
      with:
        operation: 'compile'
        working-directory: 'test-project'
        java-version: ${{ matrix.java-version }}
        maven-version: ${{ matrix.maven-version }}
        environment-variables: |
          CUSTOM_VAR=test-value
          BUILD_NUMBER=${{ github.run_number }}
    
    - name: Verify artifacts were created
      shell: bash
      run: |
        if [[ ! -f "test-project/target/test-project-1.0.0.jar" ]]; then
          echo "‚ùå JAR file not created"
          exit 1
        fi
        echo "‚úÖ Integration test passed on ${{ matrix.os }} with Java ${{ matrix.java-version }} and Maven ${{ matrix.maven-version }}"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: action-dist
        path: .
    
    - name: Run npm audit
      run: npm audit --audit-level=moderate
    
    - name: Scan action.yml for security issues
      run: |
        # Check for potential security issues in action.yml
        if grep -q "shell:" action.yml; then
          echo "‚ö†Ô∏è Warning: Shell execution found in action.yml"
        fi
        
        if grep -q "docker://" action.yml; then
          echo "‚ö†Ô∏è Warning: Docker image reference found in action.yml"
        fi
        
        echo "‚úÖ Security scan completed"

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate-version, build-and-test, integration-test, security-scan]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: action-dist
        path: .
    
    - name: Generate changelog
      id: changelog
      run: |
        VERSION="${{ needs.validate-version.outputs.version }}"
        
        # Get the previous tag
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^$VERSION$" | head -n 1)
        
        if [[ -z "$PREVIOUS_TAG" ]]; then
          echo "No previous tag found, generating changelog from first commit"
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          echo "Generating changelog from $PREVIOUS_TAG to $VERSION"
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges "$PREVIOUS_TAG"..HEAD)
        fi
        
        # Create release notes
        cat > release-notes.md << EOF
        ## What's Changed
        
        $CHANGELOG
        
        ## Installation
        
        Add this action to your workflow:
        
        \`\`\`yaml
        - name: Maven Build
          uses: dienha93/maven-actions@$VERSION
          with:
            operation: 'package'
            java-version: '17'
            maven-version: '3.9.5'
        \`\`\`
        
        ## Supported Operations
        
        - \`validate\` - Validate the project is correct
        - \`compile\` - Compile the source code
        - \`test\` - Run unit tests
        - \`package\` - Create JAR/WAR files
        - \`verify\` - Run integration tests
        - \`install\` - Install to local repository
        - \`deploy\` - Deploy to remote repository
        - \`clean\` - Clean build artifacts
        
        ## Enhanced Features
        
        - ‚úÖ Single operation execution with enhanced validation
        - ‚úÖ Custom environment variable support
        - ‚úÖ Automatic tool installation and verification
        - ‚úÖ Conditional execution based on branch/files/environment
        - ‚úÖ Enhanced error handling and reporting
        - ‚úÖ Backward compatibility with existing configurations
        
        **Full Changelog**: https://github.com/dienha93/maven-actions/compare/$PREVIOUS_TAG...$VERSION
        EOF
        
        echo "changelog-file=release-notes.md" >> $GITHUB_OUTPUT
    
    - name: Create Git tag
      if: github.event_name == 'workflow_dispatch'
      run: |
        VERSION="${{ needs.validate-version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "$VERSION" -m "Release $VERSION"
        git push origin "$VERSION"
    
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.validate-version.outputs.version }}
        release_name: ${{ needs.validate-version.outputs.version }}
        body_path: ${{ steps.changelog.outputs.changelog-file }}
        draft: false
        prerelease: ${{ needs.validate-version.outputs.is-prerelease }}
    
    - name: Update major version tag
      if: needs.validate-version.outputs.is-prerelease == 'false'
      run: |
        VERSION="${{ needs.validate-version.outputs.version }}"
        MAJOR_VERSION=$(echo "$VERSION" | sed 's/v\([0-9]*\)\..*/v\1/')
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Delete existing major version tag if it exists
        git tag -d "$MAJOR_VERSION" 2>/dev/null || true
        git push origin ":refs/tags/$MAJOR_VERSION" 2>/dev/null || true
        
        # Create new major version tag
        git tag -a "$MAJOR_VERSION" -m "Update $MAJOR_VERSION to $VERSION"
        git push origin "$MAJOR_VERSION"
        
        echo "‚úÖ Updated major version tag $MAJOR_VERSION to point to $VERSION"

  publish-marketplace:
    name: Publish to Marketplace
    runs-on: ubuntu-latest
    needs: [validate-version, create-release]
    if: needs.validate-version.outputs.is-prerelease == 'false'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.validate-version.outputs.version }}
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: action-dist
        path: .
    
    - name: Validate action.yml for marketplace
      run: |
        # Validate required fields for marketplace
        if ! grep -q "^name:" action.yml; then
          echo "‚ùå Missing 'name' field in action.yml"
          exit 1
        fi
        
        if ! grep -q "^description:" action.yml; then
          echo "‚ùå Missing 'description' field in action.yml"
          exit 1
        fi
        
        if ! grep -q "^author:" action.yml; then
          echo "‚ùå Missing 'author' field in action.yml"
          exit 1
        fi
        
        if ! grep -q "^branding:" action.yml; then
          echo "‚ùå Missing 'branding' field in action.yml"
          exit 1
        fi
        
        echo "‚úÖ action.yml validation passed for marketplace"
    
    - name: Verify README exists
      run: |
        if [[ ! -f "README.md" ]]; then
          echo "‚ùå README.md not found"
          exit 1
        fi
        
        # Check README has minimum required content
        if ! grep -q "# Maven Build Action" README.md; then
          echo "‚ö†Ô∏è Warning: README.md should have a proper title"
        fi
        
        if ! grep -q "## Usage" README.md; then
          echo "‚ö†Ô∏è Warning: README.md should have a Usage section"
        fi
        
        echo "‚úÖ README.md validation passed"
    
    - name: Check for sensitive information
      run: |
        # Check for potential secrets or sensitive information
        if grep -r -i "password\|secret\|token\|key" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" .; then
          echo "‚ö†Ô∏è Warning: Potential sensitive information found"
          echo "Please review the above matches to ensure no secrets are exposed"
        fi
        
        echo "‚úÖ Security check completed"
    
    - name: Marketplace publication notice
      run: |
        VERSION="${{ needs.validate-version.outputs.version }}"
        echo "üöÄ Action $VERSION is ready for marketplace publication!"
        echo ""
        echo "The action has been:"
        echo "‚úÖ Built and tested successfully"
        echo "‚úÖ Integration tested across multiple platforms"
        echo "‚úÖ Security scanned"
        echo "‚úÖ Released on GitHub"
        echo ""
        echo "To complete marketplace publication:"
        echo "1. Visit: https://github.com/marketplace/actions"
        echo "2. Click 'Publish a GitHub Action'"
        echo "3. Select this repository"
        echo "4. Follow the marketplace submission process"
        echo ""
        echo "Or the action will be automatically available at:"
        echo "https://github.com/marketplace/actions/maven-build-action"

  notify-completion:
    name: Notify Release Completion
    runs-on: ubuntu-latest
    needs: [validate-version, create-release, publish-marketplace]
    if: always()
    
    steps:
    - name: Release Summary
      run: |
        VERSION="${{ needs.validate-version.outputs.version }}"
        
        echo "## üéâ Release Summary for $VERSION"
        echo ""
        
        if [[ "${{ needs.create-release.result }}" == "success" ]]; then
          echo "‚úÖ GitHub Release: Created successfully"
          echo "üì¶ Release URL: https://github.com/dienha93/maven-actions/releases/tag/$VERSION"
        else
          echo "‚ùå GitHub Release: Failed"
        fi
        
        if [[ "${{ needs.publish-marketplace.result }}" == "success" ]]; then
          echo "‚úÖ Marketplace: Ready for publication"
        elif [[ "${{ needs.publish-marketplace.result }}" == "skipped" ]]; then
          echo "‚è≠Ô∏è Marketplace: Skipped (pre-release)"
        else
          echo "‚ùå Marketplace: Failed"
        fi
        
        echo ""
        echo "## Usage"
        echo "\`\`\`yaml"
        echo "- name: Maven Build"
        echo "  uses: dienha93/maven-actions@$VERSION"
        echo "  with:"
        echo "    operation: 'package'"
        echo "    java-version: '17'"
        echo "    maven-version: '3.9.5'"
        echo "\`\`\`"